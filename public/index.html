<!DOCTYPE html>
<html lang='en'>
<head>
  <meta charset='UTF-8' />
  <meta name='viewport' content='width=device-width, initial-scale=1.0'/>
  <title>Pre‑Survey — Sandbox</title>
  <link rel='stylesheet' href='https://unpkg.com/leaflet@1.9.4/dist/leaflet.css'/>
  <style>
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:#f7f7f8}
    #app{display:grid;grid-template-columns:1.6fr 1fr;grid-template-rows:auto 1fr;height:100vh}
    #toolbar{grid-column:1/3;display:flex;gap:8px;padding:10px 14px;border-bottom:1px solid #e5e7eb;align-items:center;background:#fff}
    #map{grid-column:1/2;grid-row:2/3}
    #panel{grid-column:2/3;grid-row:2/3;padding:12px;overflow:auto;border-left:1px solid #e5e7eb;background:#fafafa}
    .card{border:1px solid #e5e7eb;border-radius:12px;padding:12px;margin:10px 0;background:#fff;box-shadow:0 1px 3px rgba(0,0,0,.04)}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .kpi{flex:1;min-width:140px;border:1px solid #eee;border-radius:10px;padding:10px;background:#fafafa}
    .kpi b{display:block;font-size:12px;opacity:.7}
    .kpi span{font-size:20px}
    .chips{display:flex;gap:6px;flex-wrap:wrap}
    .chip{padding:6px 8px;border:1px solid #e5e7eb;border-radius:999px;background:#f1f5f9;font-size:12px}
    .chip.warn{background:#fff7ed;border-color:#fed7aa}
    .form{display:grid;grid-template-columns:1fr;gap:8px}
    input,select,button{padding:8px;border:1px solid #d1d5db;border-radius:8px;background:#fff;cursor:pointer}
    img{max-width:100%;border-radius:10px;border:1px solid #e5e7eb}
    .small{font-size:12px;opacity:.8}
    .error{background:#fff5f5;border:1px solid #fecaca;color:#991b1b;padding:8px;border-radius:8px;margin:8px 0;display:none}
    .badge{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid #e5e7eb;background:#eef2ff;color:#3730a3}
    @media print{ #map{height:300px}.no-print{display:none} body{background:#fff} }
  </style>
</head>
<body>
<div id='app'>
  <div id='toolbar'>
    <strong>Pre‑Survey (Sandbox)</strong>
    <span id='modeBadge' class='badge' style='display:none'>Sandbox live mode</span>
    <span style='flex:1'></span>
    <button class='no-print' id='pdfBtn' type='button'>Download PDF</button>
  </div>

  <div id='map'></div>

  <div id='panel'>
    <div class='card'>
      <div class='form'>
        <div class='row'>
          <div style='flex:1;min-width:220px'>
            <label>Depot (Mock)</label>
            <select id='depot'></select>
          </div>
          <div style='flex:1;min-width:220px'>
            <label>Customer Address (Mock)</label>
            <select id='customer'></select>
          </div>
        </div>
        <div class='row'>
          <div style='flex:1;min-width:220px'>
            <label>Depot (Free text)</label>
            <input id='depotText' placeholder='e.g., 12 Patcham Terrace, SW8'/>
          </div>
          <div style='flex:1;min-width:220px'>
            <label>Customer Address (Free text)</label>
            <input id='custText' placeholder='e.g., 21 Soho Square, W1D 3QP'/>
          </div>
        </div>
        <p class='small'>Tip: Leave the free-text boxes empty to use Mock mode. Fill BOTH to test <b>Sandbox live mode</b> without a Google key.</p>
        <div id='err' class='error'></div>
        <button id='analyzeBtn' class='no-print' type='button'>Analyse Address</button>
      </div>
    </div>

    <div id='propertyCard' class='card' style='display:none'>
      <h3>Property</h3>
      <div class='row'>
        <div style='flex:1;min-width:260px'><img id='streetImg' alt='Street view'/></div>
        <div style='flex:1;min-width:220px'><img id='satImg' alt='Satellite'/></div>
      </div>
      <div class='chips' id='propertyChips'></div>
    </div>

    <div id='parkingCard' class='card' style='display:none'>
      <h3>Parking & Kerbside</h3>
      <div class='chips' id='parkingChips'></div>
      <ul id='parkingNotes' class='small'></ul>
    </div>

    <div id='buildingCard' class='card' style='display:none'>
      <h3>Building Metadata</h3>
      <div class='row'>
        <div class='kpi'><b>Floors</b><span id='bFloors'>—</span></div>
        <div class='kpi'><b>Lift</b><span id='bLift'>—</span></div>
        <div class='kpi'><b>Door Width</b><span id='bDoor'>—</span></div>
        <div class='kpi'><b>Stair Width</b><span id='bStair'>—</span></div>
        <div class='kpi'><b>Rear Access</b><span id='bRear'>—</span></div>
      </div>
    </div>

    <div id='safetyCard' class='card' style='display:none'>
      <h3>Safety / Risk</h3>
      <div class='chips' id='safetyChips'></div>
    </div>

    <div id='weatherCard' class='card' style='display:none'>
      <h3>Weather</h3>
      <div class='row'>
        <div class='kpi'><b>Condition</b><span id='wCond'>—</span></div>
        <div class='kpi'><b>Temp</b><span id='wTemp'>—</span></div>
        <div class='kpi'><b>Wind</b><span id='wWind'>—</span></div>
        <div class='kpi'><b>Precip</b><span id='wPrecip'>—</span></div>
      </div>
      <ul id='wImpact' class='small'></ul>
    </div>

    <div id='accessCard' class='card' style='display:none'>
      <h3>Access & Recommendations</h3>
      <div class='chips' id='accessChips'></div>
      <ul id='accessNotes'></ul>
      <div class='row'>
        <div class='kpi'><b>Crew</b><span id='crewRec'>—</span></div>
        <div class='kpi'><b>Equipment</b><span id='equipRec'>—</span></div>
      </div>
    </div>

    <div id='routeCard' class='card' style='display:none'>
      <h3>Route</h3>
      <div class='row'>
        <div class='kpi'><b>Distance</b><span id='dist'>—</span></div>
        <div class='kpi'><b>ETA</b><span id='eta'>—</span></div>
        <div class='kpi'><b>Leave By</b><span id='leaveBy'>—</span></div>
      </div>
      <ul id='incidents'></ul>
    </div>

    <div id='complianceCard' class='card' style='display:none'>
      <h3>Compliance & Paperwork</h3>
      <div class='chips' id='complianceChips'></div>
      <p class='small'>Parking waiver link (mock): <a id='waiverLink' href='#' target='_blank'>Open</a></p>
      <h4>Risk Checklist</h4>
      <ul id='riskList'></ul>
    </div>
  </div>
</div>

<script src='https://unpkg.com/leaflet@1.9.4/dist/leaflet.js'></script>
<script>
let map=L.map('map').setView([51.509,-0.118],12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
let originMarker, destMarker, routeLine;

async function getJSON(url, opts){ const r=await fetch(url, opts); if(!r.ok) throw new Error(r.status+' '+r.statusText); return r.json(); }
function chip(text, warn=false){ const s=document.createElement('span'); s.className='chip'+(warn?' warn':''); s.textContent=text; return s; }
function showErr(msg){ const el=document.getElementById('err'); el.textContent=msg; el.style.display='block'; }
function hideErr(){ const el=document.getElementById('err'); el.textContent=''; el.style.display='none'; }

async function loadSamples(){
  const data = await getJSON('/api/sample_addresses');
  const depotSel = document.getElementById('depot');
  const custSel = document.getElementById('customer');
  depotSel.innerHTML = ''; custSel.innerHTML='';
  data.depots.forEach(d=>{const o=document.createElement('option'); o.value=d.id; o.textContent=d.label; depotSel.appendChild(o);});
  data.customers.forEach(c=>{const o=document.createElement('option'); o.value=c.id; o.textContent=c.label; custSel.appendChild(o);});
}

async function analyse(){
  hideErr();
  try{
    const depotId = document.getElementById('depot').value;
    const custId  = document.getElementById('customer').value;
    const depotText = document.getElementById('depotText').value.trim();
    const custText  = document.getElementById('custText').value.trim();

    let payload = {};
    let modeBadge = document.getElementById('modeBadge');

    if(depotText && custText){ payload = { depot_address_text: depotText, customer_address_text: custText }; modeBadge.style.display='inline-block'; }
    else { payload = { depot_id: depotId, customer_address_id: custId }; modeBadge.style.display='none'; }

    const intake = await getJSON('/api/intake',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
    if(intake.error){ showErr('Intake failed: '+(intake.hint||intake.error)); return; }

    if(originMarker) originMarker.remove(); if(destMarker) destMarker.remove(); if(routeLine) routeLine.remove();
    originMarker = L.marker([intake.origin.lat, intake.origin.lng]).addTo(map).bindPopup(intake.origin.label);
    destMarker = L.marker([intake.dest.lat, intake.dest.lng]).addTo(map).bindPopup(intake.dest.label);
    const bounds = L.latLngBounds([ [intake.origin.lat, intake.origin.lng], [intake.dest.lat, intake.dest.lng] ]);
    map.fitBounds(bounds, {padding:[30,30]});

    // property image
    let pimg;
    if(intake.mode==='live_text' || intake.mode==='sandbox_text'){ pimg = await getJSON(`/api/property-image?lat=${intake.dest.lat}&lng=${intake.dest.lng}`); }
    else { pimg = await getJSON('/api/property-image?address_id='+payload.customer_address_id); }
    if(pimg.error){ showErr('Property image failed'); } else {
      document.getElementById('streetImg').src = pimg.image_url;
      document.getElementById('satImg').src    = pimg.satellite_url;
      const chips = document.getElementById('propertyChips'); chips.innerHTML='';
      chips.appendChild(chip('Type: '+(pimg.type_guess||'unknown')));
      document.getElementById('propertyCard').style.display='block';
    }

    // mock layers choose id
    const addrId = (intake.mode==='mock_ids') ? payload.customer_address_id : 'cust_1';

    const park = await getJSON('/api/parking?address_id='+addrId);
    const pchips = document.getElementById('parkingChips'); pchips.innerHTML='';
    if(park.cpz) pchips.appendChild(chip('CPZ: '+park.cpz, true));
    if(park.red_route) pchips.appendChild(chip('Red Route', true));
    if(park.bus_lane) pchips.appendChild(chip('Bus Lane', true));
    (park.bay_types||[]).forEach(b=>pchips.appendChild(chip('Bay: '+b)));
    const pnotes=document.getElementById('parkingNotes'); pnotes.innerHTML='';
    (park.restrictions||[]).forEach(r=>{const li=document.createElement('li'); li.textContent=r; pnotes.appendChild(li);});
    document.getElementById('parkingCard').style.display='block';

    const bld = await getJSON('/api/building?address_id='+addrId);
    document.getElementById('bFloors').textContent = bld.floors ?? '—';
    document.getElementById('bLift').textContent   = (bld.lift===null? '—': (bld.lift? 'Yes':'No'));
    document.getElementById('bDoor').textContent   = (bld.door_width_cm? bld.door_width_cm+' cm':'—');
    document.getElementById('bStair').textContent  = (bld.stair_width_cm? bld.stair_width_cm+' cm':'—');
    document.getElementById('bRear').textContent   = (bld.rear_access===null? '—': (bld.rear_access? 'Yes':'No'));
    document.getElementById('buildingCard').style.display='block';

    const saf = await getJSON('/api/safety?address_id='+addrId);
    const schips = document.getElementById('safetyChips'); schips.innerHTML='';
    if(saf.width_restriction) schips.appendChild(chip('Width: '+saf.width_restriction, true));
    if(saf.low_bridge) schips.appendChild(chip('Low bridge: '+saf.low_bridge, true));
    if(saf.one_way) schips.appendChild(chip('One-way system', true));
    if(saf.steep_gradient) schips.appendChild(chip('Steep gradient', true));
    if(saf.crime_risk) schips.appendChild(chip('Crime risk: '+saf.crime_risk, saf.crime_risk==='High'));
    document.getElementById('safetyCard').style.display='block';

    const wx = await getJSON(`/api/weather?lat=${intake.dest.lat}&lng=${intake.dest.lng}`);
    document.getElementById('wCond').textContent = wx.condition ?? '—';
    document.getElementById('wTemp').textContent = (wx.temp_c!=null?wx.temp_c+' °C':'—');
    document.getElementById('wWind').textContent = (wx.wind_kmh!=null?wx.wind_kmh+' km/h':'—');
    document.getElementById('wPrecip').textContent = (wx.precip_chance_pct!=null?wx.precip_chance_pct+'%':'—');
    const wimp=document.getElementById('wImpact'); wimp.innerHTML='';
    (wx.impact||[]).forEach(i=>{const li=document.createElement('li'); li.textContent=i; wimp.appendChild(li);});
    document.getElementById('weatherCard').style.display='block';

    const acc = await getJSON('/api/access-insights?address_id='+addrId);
    const ax = document.getElementById('accessChips'); ax.innerHTML='';
    ax.appendChild(chip(acc.driveway? 'Driveway: Yes':'Driveway: No', !acc.driveway));
    ax.appendChild(chip(acc.stairs_visible? 'Stairs visible':'No stairs', acc.stairs_visible));
    ax.appendChild(chip(acc.double_yellow? 'Double yellow nearby':'No double yellow', acc.double_yellow));
    if(acc.red_route) ax.appendChild(chip('Red route', true));
    if(acc.narrow_road) ax.appendChild(chip('Narrow road', true));
    if(park.cpz) ax.appendChild(chip('Parking: '+park.cpz, true));
    const notes = document.getElementById('accessNotes'); notes.innerHTML='';
    (acc.notes||[]).forEach(n=>{ const li=document.createElement('li'); li.textContent=n; notes.appendChild(li); });
    document.getElementById('crewRec').textContent = acc.crew_recommendation || '—';
    document.getElementById('equipRec').textContent = (acc.equipment||[]).join(', ') || '—';
    document.getElementById('accessCard').style.display='block';

    let route;
    if(intake.mode==='live_text' || intake.mode==='sandbox_text'){
      route = await getJSON(`/api/route?origin_lat=${intake.origin.lat}&origin_lng=${intake.origin.lng}&dest_lat=${intake.dest.lat}&dest_lng=${intake.dest.lng}`);
    }else{
      route = await getJSON(`/api/route?origin_id=${payload.depot_id}&dest_id=${payload.customer_address_id}`);
    }
    if(route.error){ showErr('Route failed: '+(route.hint||route.error)); }
    else {
      document.getElementById('dist').textContent = route.distance_km + ' km';
      document.getElementById('eta').textContent  = route.eta_minutes + ' min';
      document.getElementById('leaveBy').textContent = route.leave_by || '—';
      const inc = document.getElementById('incidents'); inc.innerHTML='';
      (route.incidents||[]).forEach(i=>{ const li=document.createElement('li'); li.textContent=i; inc.appendChild(li); });
      if(route.polyline && route.polyline.type==='LineString'){
        routeLine = L.polyline(route.polyline.coordinates.map(([lng,lat])=>[lat,lng]), {weight:4, opacity:0.7}).addTo(map);
      }
      document.getElementById('routeCard').style.display='block';
    }

    const comp = await getJSON('/api/compliance?address_id='+addrId);
    const cchips = document.getElementById('complianceChips'); cchips.innerHTML='';
    cchips.appendChild(chip(comp.waiver_required? 'Waiver: Required':'Waiver: Not Needed', comp.waiver_required));
    const wlink = document.getElementById('waiverLink'); wlink.href = comp.waiver_link; wlink.textContent = comp.waiver_link;
    const rlist = document.getElementById('riskList'); rlist.innerHTML='';
    (comp.risk_checklist||[]).forEach(it=>{ const li=document.createElement('li'); li.textContent = `${it.item} — ${it.status}`; rlist.appendChild(li); });
    document.getElementById('complianceCard').style.display='block';

  }catch(e){
    console.error(e);
    showErr('Something went wrong: '+(e.message||e));
  }
}

document.getElementById('analyzeBtn').addEventListener('click', analyse);
document.getElementById('pdfBtn').addEventListener('click', ()=>window.print());

(async function init(){
  await loadSamples();
  analyse();
})();
</script>
</body>
</html>
